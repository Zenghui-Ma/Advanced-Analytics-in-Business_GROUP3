{"aid": "40061261", "title": "Getting TAI time on a Debian machine", "url": "https://www.bortzmeyer.org/tai-on-debian.html", "domain": "bortzmeyer.org", "votes": 1, "user": "todsacerdoti", "posted_at": "2024-04-17 06:47:55", "comments": 0, "source_title": "Blog St\u00e9phane Bortzmeyer: Getting TAI time on a Debian machine", "source_text": "Blog St\u00e9phane Bortzmeyer: Getting TAI time on a Debian machine\n\n# Mon blog\n\n### Autres trucs\n\nAccueil\n\nSeulement les RFC\n\nSeulement les fiches de lecture\n\nMon livre \u00ab Cyberstructure \u00bb\n\n\u00c8ve\n\n## Getting TAI time on a Debian machine\n\nFirst publication of this article on 16 April 2024\n\nIt should work by default but, apparently, on some operating systems like\nDebian, it does not: to get the TAI time, you need a small configuration\nchange. I document it here for myself or for people which will use a search\nengine and find this page.\n\nTAI is useful because, unlike UTC, it never repeats a second, neither it\nmisses one (UTC does, because of leap seconds). This makes it convenient, for\ninstance for Internet servers. But how to get TAI time on a Debian machine?\n\nThe official answer is that when you use clock_gettime in a C program or\ntime.clock_gettime in a Python one, you need to pass the option CLOCK_TAI. One\ncan easily check that, on a Debian stable machine (version 12.5), it does not\nwork: you get the same value with CLOCK_TAI or CLOCK_REALTIME (the typical\nclock, set on UTC).Unfortunately, no error code will tell you that something\nwas wrong.\n\nIt seems that the kernel (which manages the clock and asnwers to\nclock_gettime) knows only UTC and, to convert to TAI, it needs to know the\noffset (currently 37 seconds). Debian has a file to do so, a leap seconds\ntable, in /usr/share/zoneinfo/leap-seconds.list. This file contains all the\ninformation necessary to get TAI from UTC. But someone has to read it and to\ninform the kernel. This is typically done by ntpd. But it is not done by\ndefault, this is why the above test failed.\n\nSo, the system administrator needs to configure ntpd to load this file. This\nis done in /etc/ntpsec/ntp.conf (or /etc/ntp.conf depending on the version of\nntpd you use) by adding this line:\n\n    \n    \n    leapfile /usr/share/zoneinfo/leap-seconds.list\n\nand restarting ntpd and waiting some time for the kernel to synchronize, it is\nnot instantaneous.\n\nIf you see in the log file (for instance with journalctl -n 10000 -t ntpd | grep -i leap) something like:\n    \n    \n    Apr 16 08:25:39 mymachine ntpd[29050]: CLOCK: leapsecond file ('/var/lib/ntp/leap-seconds.list'): open failed: Permission denied\n\n(note the file name, which is not the default one), it means you need to check\nthe permissions of the file and that systemd or AppArmor are not adding some\nrestrictions (the default AppArmor profile of ntpd on Debian includes\n/usr/share/zoneinfo/leap-seconds.list but may be you changed something).\n\nYou can check that the kernel now knows the truth, for instance with a simple\nPython session:\n\n    \n    \n    % python Python 3.11.2 (main, Mar 13 2023, 12:18:29) [GCC 12.2.0] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information. >>> import time >>> time.clock_gettime(time.CLOCK_TAI) 1713284374.8322737 >>> time.clock_gettime(time.CLOCK_REALTIME) 1713284337.8329697\n\nYou can see that there is indeed 37 seconds of difference (plus a small value\nbecause of the delay between the two commands).\n\nThat's all. You can now use TAI in your programs. The file\n/usr/share/zoneinfo/leap-seconds.list is automatically managed by Debian (it\nis part of the package tzdata, and the reference version is\nhttps://data.iana.org/time-zones/tzdb/leap-seconds.list) so you don't need the\nprograms like ntpleapfetch which are necessary on other operating systems.\n\nThanks to Nicolas Sapa and Matthieu Herrb for the useful help.\n\nVersion PDF de cette page (mais vous pouvez aussi imprimer depuis votre\nnavigateur, il y a une feuille de style pr\u00e9vue pour cela)\n\nSource XML de cette page (cette page est distribu\u00e9e sous les termes de la\nlicence GFDL)\n\nRemarks about this blog should be sent to St\u00e9phane Bortzmeyer\n<stephane+blog@bortzmeyer.org>. I operate by Crocker's Rules so do not\nhesitate to speak plainly and frankly.\n\nThis blog is strictly personal: I do not speak for my employers, either past\nor present.\n\n", "frontpage": false}
